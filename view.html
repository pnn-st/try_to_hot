<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management - NU Exchange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-50 via-gray-100 to-gray-200">
    <div id="nav-container"></div>

    <!-- Main Content Container -->
    <div class="container mx-auto px-6 py-12">
        <div class="slide-in">
            <!-- Enhanced Header -->
            <div class="text-center mb-12">
                <div class="inline-block p-6 rounded-full gradient-bg text-white shadow-2xl mb-6">
                    <i data-lucide="database" class="w-16 h-16"></i>
                </div>
                <h1
                    class="text-6xl p-5 font-bold bg-gradient-to-r from-red-600 to-red-800 bg-clip-text text-transparent mb-4">
                    Exchange Records
                </h1>
            </div>

            <!-- Enhanced Data Table Container -->
            <div
                class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl overflow-hidden border border-white/20 table-container">
                <!-- Enhanced Header -->
                <div class="gradient-bg text-white p-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-bold">Student Exchange Database</h2>
                            <p class="text-red-100 mt-2">Manage and view all exchange applications</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="bg-white/20 rounded-lg px-4 py-2">
                                <span class="text-sm font-medium">Total Records: </span>
                                <span class="text-xl font-bold" id="totalRecords">0</span>
                            </div>
                            <button onclick="exportData()"
                                class="bg-white/20 hover:bg-white/30 rounded-lg px-4 py-2 transition-colors flex items-center space-x-2">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span class="font-medium">Export</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Filters Section -->
                <div class="p-8 bg-gradient-to-r from-gray-50 to-gray-100 border-b">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Search Input -->
                        <div class="lg:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i data-lucide="search" class="inline w-4 h-4 mr-2"></i>Search Records
                            </label>
                            <div class="relative">
                                <input type="text" id="searchInput"
                                    placeholder="Search by name, student ID, or email..."
                                    class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:outline-none input-focus">
                                <i data-lucide="search" class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"></i>
                            </div>
                        </div>

                        <!-- Major Filter -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i data-lucide="graduation-cap" class="inline w-4 h-4 mr-2"></i>Major
                            </label>
                            <select id="filterMajor"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:outline-none input-focus">
                                <option value="">All Majors</option>
                                <option value="ce">Civil Engineering</option>
                                <option value="ie">Industrial Engineering</option>
                                <option value="me">Mechanical Engineering</option>
                                <option value="ee">Electrical Engineering</option>
                                <option value="cpe">Computer Engineering</option>
                                <option value="envi">Environmental Engineering</option>
                                <option value="mate">Materials Engineering</option>
                                <option value="chem">Chemical Engineering</option>
                                <option value="iie">Intelligent Innovation Engineering</option>
                            </select>
                        </div>

                        <!-- Year Filter -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i data-lucide="calendar" class="inline w-4 h-4 mr-2"></i>Academic Year
                            </label>
                            <select id="filterYear"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:outline-none input-focus">
                                <option value="">All Years</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                                <option value="5">5th Year</option>
                                <option value="6">6th Year</option>
                                <option value="7">7th Year</option>
                                <option value="8">8th Year</option>
                            </select>
                        </div>
                    </div>

                    <!-- Additional Filters Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i data-lucide="globe" class="inline w-4 h-4 mr-2"></i>Program Type
                            </label>
                            <select id="filterType"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:outline-none input-focus">
                                <option value="">All Types</option>
                                <option value="inbound">Inbound</option>
                                <option value="outbound">Outbound</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i data-lucide="map-pin" class="inline w-4 h-4 mr-2"></i>Country
                            </label>
                            <select id="filterCountry"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:outline-none input-focus">
                                <option value="">All Countries</option>
                            </select>
                        </div>

                        <div class="flex items-end">
                            <button onclick="clearFilters()"
                                class="w-full px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-xl transition-colors flex items-center justify-center space-x-2">
                                <i data-lucide="x" class="w-4 h-4"></i>
                                <span>Clear Filters</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors"
                                    onclick="sortTable('name')">
                                    <div class="flex items-center space-x-2">
                                        <span>Student Name</span>
                                        <i data-lucide="chevrons-up-down" class="w-4 h-4"></i>
                                    </div>
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Student ID
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Contact
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors"
                                    onclick="sortTable('major')">
                                    <div class="flex items-center space-x-2">
                                        <span>Major</span>
                                        <i data-lucide="chevrons-up-down" class="w-4 h-4"></i>
                                    </div>
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Program
                                </th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Country
                                </th>
                                <th
                                    class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="dataBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- No Data State -->
                <div id="noDataMessage" class="hidden text-center py-16">
                    <div class="w-20 h-20 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="database" class="w-10 h-10 text-gray-400"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No records found</h3>
                    <p class="text-gray-500">Try adjusting your filters or add new exchange records.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let allData = [];
        let filteredData = [];
        let sortColumn = '';
        let sortDirection = 'asc';

        // Page initialization
        document.addEventListener('DOMContentLoaded', function () {
            loadNavigation();
            initializeIcons();
            loadData();
            setupEventListeners();
            populateCountryFilter();
            renderTable();
        });

        // Load and refresh data
        async function loadData() {
            allData = await ExchangeDataManager.loadData();
            filteredData = [...allData];
            updateRecordCount();
            renderTable();
        }

        async function refreshTable() {
            await loadData();
            renderTable();
        }

        // Setup event listeners
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const filterMajor = document.getElementById('filterMajor');
            const filterYear = document.getElementById('filterYear');
            const filterType = document.getElementById('filterType');
            const filterCountry = document.getElementById('filterCountry');

            // Debounced search
            if (searchInput) {
                searchInput.addEventListener('input', UIUtils.debounce(applyFilters, 300));
            }

            // Filter listeners
            [filterMajor, filterYear, filterType, filterCountry].forEach(filter => {
                if (filter) filter.addEventListener('change', applyFilters);
            });
        }

        // Populate country filter dropdown
        function populateCountryFilter() {
            const countries = [...new Set(allData.map(item => item.country))].filter(Boolean).sort();
            const filterCountry = document.getElementById('filterCountry');

            if (filterCountry) {
                // Clear existing options except "All Countries"
                filterCountry.innerHTML = '<option value="">All Countries</option>';
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    filterCountry.appendChild(option);
                });
            }
        }

        // Enhanced table rendering
        function renderTable() {
            const tbody = document.getElementById('dataBody');
            const noDataMessage = document.getElementById('noDataMessage');

            if (!tbody) return;

            if (filteredData.length === 0) {
                tbody.innerHTML = '';
                noDataMessage.classList.remove('hidden');
                return;
            }

            noDataMessage.classList.add('hidden');
            tbody.innerHTML = filteredData.map((record, index) => `
                <tr class="hover:bg-gradient-to-r hover:from-red-50 hover:to-red-50 transition-all duration-200 table-row">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-700 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white font-bold text-sm">${record.name ? record.name.charAt(0).toUpperCase() : 'N'}</span>
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">${record.name || 'N/A'}</div>
                                <div class="text-sm text-gray-500">${record.project || 'No project specified'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${record.studentId || 'N/A'}</div>
                        <div class="text-sm text-gray-500">Year ${record.year || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${record.email || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${record.phone || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${TableManager.getMajorName(record.major)}</div>
                        <div class="text-sm text-gray-500">${record.adviser || 'No adviser'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full ${record.formType === 'inbound' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                            <i data-lucide="${record.formType === 'inbound' ? 'arrow-down-right' : 'arrow-up-right'}" class="w-3 h-3 mr-1"></i>
                            ${record.formType || 'inbound'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${record.country || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${record.university || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="viewRecord(${allData.indexOf(record)})" 
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg transition-colors text-xs font-medium flex items-center space-x-1">
                                <i data-lucide="eye" class="w-3 h-3"></i>
                                <span>View</span>
                            </button>
                            <button onclick="editRecord(${allData.indexOf(record)})" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg transition-colors text-xs font-medium flex items-center space-x-1">
                                <i data-lucide="edit" class="w-3 h-3"></i>
                                <span>Edit</span>
                            </button>
                            <button onclick="deleteRecord(${allData.indexOf(record)})" 
                                class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg transition-colors text-xs font-medium flex items-center space-x-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                <span>Delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            initializeIcons();
        }

        // Enhanced filtering
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const majorFilter = document.getElementById('filterMajor')?.value || '';
            const yearFilter = document.getElementById('filterYear')?.value || '';
            const typeFilter = document.getElementById('filterType')?.value || '';
            const countryFilter = document.getElementById('filterCountry')?.value || '';

            filteredData = allData.filter(record => {
                const matchesSearch =
                    record.name?.toLowerCase().includes(searchTerm) ||
                    record.studentId?.toLowerCase().includes(searchTerm) ||
                    record.email?.toLowerCase().includes(searchTerm);

                const matchesMajor = !majorFilter || record.major === majorFilter;
                const matchesYear = !yearFilter || record.year === yearFilter;
                const matchesType = !typeFilter || record.formType === typeFilter;
                const matchesCountry = !countryFilter || record.country === countryFilter;

                return matchesSearch && matchesMajor && matchesYear && matchesType && matchesCountry;
            });

            renderTable();
            updateRecordCount();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterMajor').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterCountry').value = '';

            filteredData = [...allData];
            renderTable();
            updateRecordCount();
        }

        // Update record count display
        function updateRecordCount() {
            const totalRecords = document.getElementById('totalRecords');
            if (totalRecords) {
                totalRecords.textContent = filteredData.length;
            }
        }

        // Enhanced record actions
        function viewRecord(index) {
            TableManager.viewRecord(index);
        }

        function editRecord(index) {
            const record = allData[index];
            if (!record) return;

            const formHtml = generateEditForm(record, index);
            ModalManager.openModal("Edit Student Record", formHtml);
            initializeIcons();
        }

        function deleteRecord(index) {
            TableManager.deleteRecord(index);
        }

        // Generate edit form HTML
        function generateEditForm(record, index) {
            return `
                <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-6" onsubmit="handleEditSubmit(event, ${index})">
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-800 border-b pb-2 col-span-2">Personal & Academic Information</h3>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" name="name" value="${record.name || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Student ID</label>
                            <input type="text" name="studentId" value="${record.studentId || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" name="email" value="${record.email || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="tel" name="phone" value="${record.phone || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Major</label>
                            <select name="major" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                ${generateMajorOptions(record.major)}
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Year</label>
                            <select name="year" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                ${generateYearOptions(record.year)}
                            </select>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Adviser</label>
                            <input type="text" name="adviser" value="${record.adviser || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Country</label>
                            <input type="text" name="country" value="${record.country || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">University</label>
                            <input type="text" name="university" value="${record.university || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Project</label>
                            <input type="text" name="project" value="${record.project || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Funder</label>
                            <input type="text" name="funder" value="${record.funder || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Budget</label>
                            <input type="number" name="budget" value="${record.budget || ''}" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                        </div>
                    </div>
                    
                    <div class="col-span-2 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Start Date</label>
                                <input type="date" name="fromdate" value="${record.fromdate || ''}" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">End Date</label>
                                <input type="date" name="todate" value="${record.todate || ''}" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Passport Number</label>
                                <input type="text" name="passportNumber" value="${record.passportNumber || ''}" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Residence</label>
                                <input type="text" name="residence" value="${record.residence || ''}" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"/>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Program Type</label>
                            <select name="formType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                <option value="inbound" ${record.formType === 'inbound' ? 'selected' : ''}>Inbound</option>
                                <option value="outbound" ${record.formType === 'outbound' ? 'selected' : ''}>Outbound</option>
                            </select>
                        </div>
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Additional Details</label>
                            <textarea name="details" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 resize-none">${record.details || ''}</textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-6">
                            <button type="button" onclick="ModalManager.closeModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center space-x-2">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                <span>Save Changes</span>
                            </button>
                        </div>
                    </div>
                </form>
            `;
        }

        // Generate major options
        function generateMajorOptions(selectedMajor) {
            const majors = [
                { value: 'ce', label: 'Civil Engineering' },
                { value: 'ie', label: 'Industrial Engineering' },
                { value: 'me', label: 'Mechanical Engineering' },
                { value: 'ee', label: 'Electrical Engineering' },
                { value: 'cpe', label: 'Computer Engineering' },
                { value: 'envi', label: 'Environmental Engineering' },
                { value: 'mate', label: 'Materials Engineering' },
                { value: 'chem', label: 'Chemical Engineering' },
                { value: 'iie', label: 'Intelligent Innovation Engineering' }
            ];

            return majors.map(major =>
                `<option value="${major.value}" ${selectedMajor === major.value ? 'selected' : ''}>${major.label}</option>`
            ).join('');
        }

        // Generate year options
        function generateYearOptions(selectedYear) {
            const years = [1, 2, 3, 4, 5, 6, 7, 8];
            return years.map(year =>
                `<option value="${year}" ${selectedYear == year ? 'selected' : ''}>${year}${getOrdinalSuffix(year)} Year</option>`
            ).join('');
        }

        // Get ordinal suffix for numbers
        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j == 1 && k != 11) return "st";
            if (j == 2 && k != 12) return "nd";
            if (j == 3 && k != 13) return "rd";
            return "th";
        }

        // Handle edit form submission
        async function handleEditSubmit(event, index) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const updatedRecord = Object.fromEntries(formData.entries());

            // Validate the updated record
            const errors = FormValidator.validateForm(updatedRecord);
            if (errors.length > 0) {
                UIUtils.showNotification(errors[0], 'error');
                return;
            }

            // Update the record
            const success = await ExchangeDataManager.updateRecord(index, updatedRecord);
            if (success) {
                UIUtils.showNotification('Record updated successfully!', 'success');
                ModalManager.closeModal();
                await refreshTable();
                populateCountryFilter();
            } else {
                UIUtils.showNotification('Error updating record.', 'error');
            }
        }

        // Table sorting functionality
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });

            renderTable();
        }

        // Export functionality
        function exportData() {
            if (filteredData.length === 0) {
                UIUtils.showNotification('No data to export.', 'error');
                return;
            }

            const csvContent = convertToCSV(filteredData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `exchange_records_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            UIUtils.showNotification('Data exported successfully!', 'success');
        }

        // Convert data to CSV format
        function convertToCSV(data) {
            const headers = [
                'Name', 'Student ID', 'Email', 'Phone', 'Major', 'Year', 'Adviser',
                'Country', 'University', 'Project', 'Funder', 'Budget', 'Start Date',
                'End Date', 'Program Type', 'Passport Number', 'Residence', 'Details'
            ];

            const csvRows = [];
            csvRows.push(headers.join(','));

            data.forEach(record => {
                const row = [
                    record.name || '',
                    record.studentId || '',
                    record.email || '',
                    record.phone || '',
                    TableManager.getMajorName(record.major) || '',
                    record.year || '',
                    record.adviser || '',
                    record.country || '',
                    record.university || '',
                    record.project || '',
                    record.funder || '',
                    record.budget || '',
                    record.fromdate || '',
                    record.todate || '',
                    record.formType || '',
                    record.passportNumber || '',
                    record.residence || '',
                    record.details || ''
                ].map(field => `"${field.toString().replace(/"/g, '""')}"`);

                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }
    </script>
</body>

</html>
